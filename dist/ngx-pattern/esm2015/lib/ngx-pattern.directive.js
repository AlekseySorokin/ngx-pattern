import { __decorate, __param } from "tslib";
import { Directive, ElementRef, HostListener, Inject, Input, Optional } from '@angular/core';
import { NgControl } from '@angular/forms';
let NgxPatternDirective = class NgxPatternDirective {
    constructor(host, control) {
        this.host = host;
        this.control = control;
    }
    ngOnInit() {
        this.onPasteHandler = (e) => {
            this.onPaste(e);
        };
        this.onKeydownHandler = (e) => {
            this.onKeyDown(e);
        };
        this.host.nativeElement.addEventListener('keydown', this.onKeydownHandler);
        this.host.nativeElement.addEventListener('paste', this.onPasteHandler);
    }
    ngOnChanges() {
        if (this.ngxPattern) {
            if (typeof this.ngxPattern === 'string') {
                this.regex = new RegExp(`^${this.ngxPattern}$`, 'g');
            }
            else {
                this.regex = this.ngxPattern;
            }
        }
    }
    ngOnDestroy() {
        this.host.nativeElement.removeEventListener('keydown', this.onKeydownHandler);
        this.host.nativeElement.removeEventListener('paste', this.onPasteHandler);
    }
    onKeyDown(e) {
        const input = e === null || e === void 0 ? void 0 : e.currentTarget;
        this.lastValue = input.value || '';
        const { selectionStart, selectionEnd, } = this.inputEl;
        if (selectionStart !== null) {
            this.lastSelectionStart = selectionStart;
        }
        if (selectionEnd !== null) {
            this.lastSelectionEnd = selectionEnd;
        }
        if (this.regex && e && !e.ctrlKey && !e.metaKey && !isSpecialKey(e.key)) {
            if (!this.validWithChange(e.key)) {
                e.preventDefault();
            }
        }
    }
    onInput() {
        if (this.currentValue && !this.textIsValid(this.currentValue)) {
            // Mobile browsers don't support keydown preventDefault and return
            // Unidentified for the pressed key. We need to detect the change on input event and undo.
            document.execCommand('undo');
        }
    }
    onPaste(e) {
        var _a, _b;
        const pastedInput = (_a = e === null || e === void 0 ? void 0 : e.clipboardData) === null || _a === void 0 ? void 0 : _a.getData('text/plain');
        if (pastedInput) {
            e === null || e === void 0 ? void 0 : e.preventDefault();
            if (this.validWithChange(pastedInput)) {
                const text = this.lastValue.substring(0, this.lastSelectionStart) + pastedInput + this.lastValue.substring(this.lastSelectionEnd);
                if (this.control) {
                    (_b = this.control.control) === null || _b === void 0 ? void 0 : _b.setValue(text);
                }
                else {
                    this.inputEl.value = text;
                }
                this.inputEl.setSelectionRange(this.lastSelectionEnd + pastedInput.length, this.lastSelectionStart + pastedInput.length);
            }
        }
    }
    onDrop(e) {
        var _a;
        const textData = (_a = e.dataTransfer) === null || _a === void 0 ? void 0 : _a.getData('text');
        if (textData && !this.validWithChange(textData)) {
            e.preventDefault();
        }
    }
    get currentValue() {
        return this.inputEl ? this.inputEl.value : undefined;
    }
    validWithChange(delta) {
        const { value: current, selectionStart, selectionEnd, } = this.inputEl;
        if (selectionEnd === null || selectionStart === null) {
            return false;
        }
        const updated = current.substring(0, selectionStart) + delta + current.substring(selectionEnd + 1);
        return this.textIsValid(updated);
    }
    textIsValid(text) {
        const result = !text || this.regex.test(text);
        this.regex.lastIndex = 0;
        return result;
    }
    get inputEl() {
        return this.host.nativeElement;
    }
};
__decorate([
    Input()
], NgxPatternDirective.prototype, "ngxPattern", void 0);
__decorate([
    HostListener('input', [])
], NgxPatternDirective.prototype, "onInput", null);
__decorate([
    HostListener('drop', ['$event'])
], NgxPatternDirective.prototype, "onDrop", null);
NgxPatternDirective = __decorate([
    Directive({
        selector: '[ngxPattern]'
    }),
    __param(0, Inject(ElementRef)), __param(1, Optional()), __param(1, Inject(NgControl))
], NgxPatternDirective);
export { NgxPatternDirective };
/** @see https://developer.mozilla.org/bg/docs/Web/API/KeyboardEvent/key/Key_Values */
function isSpecialKey(key) {
    return key.length > 1;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBhdHRlcm4uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IkM6L1VzZXJzL9CQ0LvQtdC60YHQtdC5L1BocHN0b3JtUHJvamVjdHMvbmd4LXBhdHRlcm4vcHJvamVjdHMvbmd4LXBhdHRlcm4vc3JjLyIsInNvdXJjZXMiOlsibGliL25neC1wYXR0ZXJuLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLE1BQU0sRUFDTixLQUFLLEVBSUwsUUFBUSxFQUNULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUszQyxJQUFhLG1CQUFtQixHQUFoQyxNQUFhLG1CQUFtQjtJQVU5QixZQUF3QyxJQUFnQixFQUF5QyxPQUFrQjtRQUEzRSxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQXlDLFlBQU8sR0FBUCxPQUFPLENBQVc7SUFDbkgsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBaUIsRUFBRSxFQUFFO1lBQzFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLGdCQUFnQixHQUFHLENBQUMsQ0FBZ0IsRUFBRSxFQUFFO1lBQzNDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEIsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDekUsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxVQUFV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QixDQUFDO0lBRUQsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUNqQyxDQUFDO0NBQ0YsQ0FBQTtBQXZIVTtJQUFSLEtBQUssRUFBRTt1REFBNkI7QUEyRHJDO0lBREMsWUFBWSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7a0RBT3pCO0FBbUJEO0lBREMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lEQU9oQztBQTNGVSxtQkFBbUI7SUFIL0IsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLGNBQWM7S0FDekIsQ0FBQztJQVdhLFdBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBLEVBQTRCLFdBQUEsUUFBUSxFQUFFLENBQUEsRUFBRSxXQUFBLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtHQVY3RSxtQkFBbUIsQ0F3SC9CO1NBeEhZLG1CQUFtQjtBQTBIaEMsc0ZBQXNGO0FBQ3RGLFNBQVMsWUFBWSxDQUFDLEdBQVc7SUFDL0IsT0FBTyxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN4QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsXHJcbiAgRWxlbWVudFJlZixcclxuICBIb3N0TGlzdGVuZXIsXHJcbiAgSW5qZWN0LFxyXG4gIElucHV0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIE9wdGlvbmFsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE5nQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW25neFBhdHRlcm5dJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTmd4UGF0dGVybkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gIEBJbnB1dCgpIG5neFBhdHRlcm46IFJlZ0V4cCB8IHN0cmluZztcclxuXHJcbiAgcHJpdmF0ZSByZWdleDogUmVnRXhwO1xyXG4gIHByaXZhdGUgbGFzdFNlbGVjdGlvblN0YXJ0OiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBsYXN0U2VsZWN0aW9uRW5kOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBsYXN0VmFsdWU6IHN0cmluZztcclxuICBvblBhc3RlSGFuZGxlcjogKGU6IENsaXBib2FyZEV2ZW50KSA9PiB2b2lkO1xyXG4gIG9uS2V5ZG93bkhhbmRsZXI6IChlOiBLZXlib2FyZEV2ZW50KSA9PiB2b2lkO1xyXG5cclxuICBjb25zdHJ1Y3RvcihASW5qZWN0KEVsZW1lbnRSZWYpIHByaXZhdGUgaG9zdDogRWxlbWVudFJlZiwgQE9wdGlvbmFsKCkgQEluamVjdChOZ0NvbnRyb2wpIHByaXZhdGUgY29udHJvbDogTmdDb250cm9sKSB7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMub25QYXN0ZUhhbmRsZXIgPSAoZTogQ2xpcGJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgdGhpcy5vblBhc3RlKGUpO1xyXG4gICAgfTtcclxuICAgIHRoaXMub25LZXlkb3duSGFuZGxlciA9IChlOiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgIHRoaXMub25LZXlEb3duKGUpO1xyXG4gICAgfTtcclxuICAgIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLm9uS2V5ZG93bkhhbmRsZXIpO1xyXG4gICAgdGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncGFzdGUnLCB0aGlzLm9uUGFzdGVIYW5kbGVyKTtcclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMubmd4UGF0dGVybikge1xyXG4gICAgICBpZiAodHlwZW9mIHRoaXMubmd4UGF0dGVybiA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICB0aGlzLnJlZ2V4ID0gbmV3IFJlZ0V4cChgXiR7dGhpcy5uZ3hQYXR0ZXJufSRgLCAnZycpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMucmVnZXggPSB0aGlzLm5neFBhdHRlcm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMub25LZXlkb3duSGFuZGxlcik7XHJcbiAgICB0aGlzLmhvc3QubmF0aXZlRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdwYXN0ZScsIHRoaXMub25QYXN0ZUhhbmRsZXIpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbktleURvd24oZT86IEtleWJvYXJkRXZlbnQpOiB2b2lkIHtcclxuICAgIGNvbnN0IGlucHV0ID0gZT8uY3VycmVudFRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgdGhpcy5sYXN0VmFsdWUgPSBpbnB1dC52YWx1ZSB8fCAnJztcclxuICAgIGNvbnN0IHtcclxuICAgICAgc2VsZWN0aW9uU3RhcnQsXHJcbiAgICAgIHNlbGVjdGlvbkVuZCxcclxuICAgIH0gPSB0aGlzLmlucHV0RWw7XHJcbiAgICBpZiAoc2VsZWN0aW9uU3RhcnQgIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5sYXN0U2VsZWN0aW9uU3RhcnQgPSBzZWxlY3Rpb25TdGFydDtcclxuICAgIH1cclxuICAgIGlmIChzZWxlY3Rpb25FbmQgIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5sYXN0U2VsZWN0aW9uRW5kID0gc2VsZWN0aW9uRW5kO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMucmVnZXggJiYgZSAmJiAhZS5jdHJsS2V5ICYmICFlLm1ldGFLZXkgJiYgIWlzU3BlY2lhbEtleShlLmtleSkpIHtcclxuICAgICAgaWYgKCF0aGlzLnZhbGlkV2l0aENoYW5nZShlLmtleSkpIHtcclxuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2lucHV0JywgW10pXHJcbiAgb25JbnB1dCgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmN1cnJlbnRWYWx1ZSAmJiAhdGhpcy50ZXh0SXNWYWxpZCh0aGlzLmN1cnJlbnRWYWx1ZSkpIHtcclxuICAgICAgLy8gTW9iaWxlIGJyb3dzZXJzIGRvbid0IHN1cHBvcnQga2V5ZG93biBwcmV2ZW50RGVmYXVsdCBhbmQgcmV0dXJuXHJcbiAgICAgIC8vIFVuaWRlbnRpZmllZCBmb3IgdGhlIHByZXNzZWQga2V5LiBXZSBuZWVkIHRvIGRldGVjdCB0aGUgY2hhbmdlIG9uIGlucHV0IGV2ZW50IGFuZCB1bmRvLlxyXG4gICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgndW5kbycpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvblBhc3RlKGU/OiBDbGlwYm9hcmRFdmVudCk6IHZvaWQge1xyXG4gICAgY29uc3QgcGFzdGVkSW5wdXQgPSBlPy5jbGlwYm9hcmREYXRhPy5nZXREYXRhKCd0ZXh0L3BsYWluJyk7XHJcbiAgICBpZiAocGFzdGVkSW5wdXQpIHtcclxuICAgICAgZT8ucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgaWYgKHRoaXMudmFsaWRXaXRoQ2hhbmdlKHBhc3RlZElucHV0KSkge1xyXG4gICAgICAgIGNvbnN0IHRleHQgPSB0aGlzLmxhc3RWYWx1ZS5zdWJzdHJpbmcoMCwgdGhpcy5sYXN0U2VsZWN0aW9uU3RhcnQpICsgcGFzdGVkSW5wdXQgKyB0aGlzLmxhc3RWYWx1ZS5zdWJzdHJpbmcodGhpcy5sYXN0U2VsZWN0aW9uRW5kKTtcclxuICAgICAgICBpZiAodGhpcy5jb250cm9sKSB7XHJcbiAgICAgICAgICB0aGlzLmNvbnRyb2wuY29udHJvbD8uc2V0VmFsdWUodGV4dCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuaW5wdXRFbC52YWx1ZSA9IHRleHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5wdXRFbC5zZXRTZWxlY3Rpb25SYW5nZSh0aGlzLmxhc3RTZWxlY3Rpb25FbmQgKyBwYXN0ZWRJbnB1dC5sZW5ndGgsIHRoaXMubGFzdFNlbGVjdGlvblN0YXJ0ICsgcGFzdGVkSW5wdXQubGVuZ3RoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignZHJvcCcsIFsnJGV2ZW50J10pXHJcbiAgb25Ecm9wKGU6IERyYWdFdmVudCk6IHZvaWQge1xyXG4gICAgY29uc3QgdGV4dERhdGEgPSBlLmRhdGFUcmFuc2Zlcj8uZ2V0RGF0YSgndGV4dCcpO1xyXG5cclxuICAgIGlmICh0ZXh0RGF0YSAmJiAhdGhpcy52YWxpZFdpdGhDaGFuZ2UodGV4dERhdGEpKSB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldCBjdXJyZW50VmFsdWUoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLmlucHV0RWwgPyB0aGlzLmlucHV0RWwudmFsdWUgOiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHZhbGlkV2l0aENoYW5nZShkZWx0YTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCB7XHJcbiAgICAgIHZhbHVlOiBjdXJyZW50LFxyXG4gICAgICBzZWxlY3Rpb25TdGFydCxcclxuICAgICAgc2VsZWN0aW9uRW5kLFxyXG4gICAgfSA9IHRoaXMuaW5wdXRFbDtcclxuICAgIGlmIChzZWxlY3Rpb25FbmQgPT09IG51bGwgfHwgc2VsZWN0aW9uU3RhcnQgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdXBkYXRlZCA9IGN1cnJlbnQuc3Vic3RyaW5nKDAsIHNlbGVjdGlvblN0YXJ0KSArIGRlbHRhICsgY3VycmVudC5zdWJzdHJpbmcoc2VsZWN0aW9uRW5kICsgMSk7XHJcbiAgICByZXR1cm4gdGhpcy50ZXh0SXNWYWxpZCh1cGRhdGVkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdGV4dElzVmFsaWQodGV4dDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSAhdGV4dCB8fCB0aGlzLnJlZ2V4LnRlc3QodGV4dCk7XHJcbiAgICB0aGlzLnJlZ2V4Lmxhc3RJbmRleCA9IDA7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIGdldCBpbnB1dEVsKCk6IEhUTUxJbnB1dEVsZW1lbnQge1xyXG4gICAgcmV0dXJuIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50O1xyXG4gIH1cclxufVxyXG5cclxuLyoqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvYmcvZG9jcy9XZWIvQVBJL0tleWJvYXJkRXZlbnQva2V5L0tleV9WYWx1ZXMgKi9cclxuZnVuY3Rpb24gaXNTcGVjaWFsS2V5KGtleTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgcmV0dXJuIGtleS5sZW5ndGggPiAxO1xyXG59XHJcbiJdfQ==